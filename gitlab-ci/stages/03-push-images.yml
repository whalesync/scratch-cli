include:
  - "/gitlab-ci/stages.yml"
  - "/gitlab-ci/common.yml"

#region client

push client image to test artifact registry:
  stage: push images
  needs:
    - job: build client docker image for test
      artifacts: true
  extends:
    - .gcp_test_env # sets before_script and variables
    - .docker_builder_image
  cache: []
  services:
    - docker:26-dind
  script:
    - !reference [.setup_docker_gcp_auth, script]
    - docker load -i client/image-test.tar
    # Push twice, tagged as both 'latest' and '$CI_COMMIT_SHORT_SHA'
    - docker tag spinner/spinner-client-test:latest ${GCP_REGISTRY_URL}/spinner-client-test:$CI_COMMIT_SHORT_SHA
    - docker push ${GCP_REGISTRY_URL}/spinner-client-test:$CI_COMMIT_SHORT_SHA
    - docker tag spinner/spinner-client-test:latest ${GCP_REGISTRY_URL}/spinner-client-test:latest
    - docker push ${GCP_REGISTRY_URL}/spinner-client-test:latest
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - gitlab-ci/stages/03-push-images.yml
      when: manual
      allow_failure: true
    - !reference [.rules, on_merge_to_master]

push client image to production artifact registry:
  stage: push images
  needs:
    - job: build client docker image for production
      artifacts: true
  extends:
    - .gcp_production_env # sets before_script and variables
    - .docker_builder_image
  cache: []
  services:
    - docker:26-dind
  script:
    - !reference [.setup_docker_gcp_auth, script]
    - docker load -i client/image-production.tar
    # Push twice, tagged as both 'latest' and '$CI_COMMIT_SHORT_SHA'
    - docker tag spinner/spinner-client-production:latest ${GCP_REGISTRY_URL}/spinner-client-production:$CI_COMMIT_SHORT_SHA
    - docker push ${GCP_REGISTRY_URL}/spinner-client-production:$CI_COMMIT_SHORT_SHA
    - docker tag spinner/spinner-client-production:latest ${GCP_REGISTRY_URL}/spinner-client-production:latest
    - docker push ${GCP_REGISTRY_URL}/spinner-client-production:latest
  rules:
    - !reference [.rules, on_merge_to_prod]

#endregion

#region server

push server image to test artifact registry:
  stage: push images
  needs:
    - job: build server docker image
      artifacts: true
  extends:
    - .gcp_test_env # sets before_script and variables
    - .docker_builder_image
  cache: []
  services:
    - docker:26-dind
  script:
    - !reference [.setup_docker_gcp_auth, script]
    - docker load -i server/image.tar
    # Push twice, tagged as both 'latest' and '$CI_COMMIT_SHORT_SHA'
    - docker tag spinner/spinner-server:latest ${GCP_REGISTRY_URL}/spinner-server:$CI_COMMIT_SHORT_SHA
    - docker push ${GCP_REGISTRY_URL}/spinner-server:$CI_COMMIT_SHORT_SHA
    - docker tag spinner/spinner-server:latest ${GCP_REGISTRY_URL}/spinner-server:latest
    - docker push ${GCP_REGISTRY_URL}/spinner-server:latest
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - gitlab-ci/stages/03-push-images.yml
      when: manual
      allow_failure: true
    - !reference [.rules, on_merge_to_master]

push server image to production artifact registry:
  stage: push images
  needs:
    - job: build server docker image
      artifacts: true
  extends:
    - .gcp_production_env # sets before_script and variables
    - .docker_builder_image
  cache: []
  services:
    - docker:26-dind
  script:
    - !reference [.setup_docker_gcp_auth, script]
    - docker load -i server/image.tar
    # Push twice, tagged as both 'latest' and '$CI_COMMIT_SHORT_SHA'
    - docker tag spinner/spinner-server:latest ${GCP_REGISTRY_URL}/spinner-server:$CI_COMMIT_SHORT_SHA
    - docker push ${GCP_REGISTRY_URL}/spinner-server:$CI_COMMIT_SHORT_SHA
    - docker tag spinner/spinner-server:latest ${GCP_REGISTRY_URL}/spinner-server:latest
    - docker push ${GCP_REGISTRY_URL}/spinner-server:latest
  rules:
    - !reference [.rules, on_merge_to_prod]

#endregion

#region agent

push agent image to test artifact registry:
  stage: push images
  needs:
    - job: build agent docker image
      artifacts: true
  extends:
    - .gcp_test_env # sets before_script and variables
    - .docker_builder_image
  cache: []
  services:
    - docker:26-dind
  script:
    - !reference [.setup_docker_gcp_auth, script]
    - docker load -i pydantic-ai-agent/image.tar
    # Push twice, tagged as both 'latest' and '$CI_COMMIT_SHORT_SHA'
    - docker tag spinner/spinner-agent:latest ${GCP_REGISTRY_URL}/spinner-agent:$CI_COMMIT_SHORT_SHA
    - docker push ${GCP_REGISTRY_URL}/spinner-agent:$CI_COMMIT_SHORT_SHA
    - docker tag spinner/spinner-agent:latest ${GCP_REGISTRY_URL}/spinner-agent:latest
    - docker push ${GCP_REGISTRY_URL}/spinner-agent:latest
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - gitlab-ci/stages/03-push-images.yml
      when: manual
      allow_failure: true
    - !reference [.rules, on_merge_to_master]

push agent image to production artifact registry:
  stage: push images
  needs:
    - job: build agent docker image
      artifacts: true
  extends:
    - .gcp_production_env # sets before_script and variables
    - .docker_builder_image
  cache: []
  services:
    - docker:26-dind
  script:
    - !reference [.setup_docker_gcp_auth, script]
    - docker load -i pydantic-ai-agent/image.tar
    # Push twice, tagged as both 'latest' and '$CI_COMMIT_SHORT_SHA'
    - docker tag spinner/spinner-agent:latest ${GCP_REGISTRY_URL}/spinner-agent:$CI_COMMIT_SHORT_SHA
    - docker push ${GCP_REGISTRY_URL}/spinner-agent:$CI_COMMIT_SHORT_SHA
    - docker tag spinner/spinner-agent:latest ${GCP_REGISTRY_URL}/spinner-agent:latest
    - docker push ${GCP_REGISTRY_URL}/spinner-agent:latest
  rules:
    - !reference [.rules, on_merge_to_prod]
#endregion

#region scratch-git

push scratch-git image to test artifact registry:
  stage: push images
  needs:
    - job: build scratch-git docker image
      artifacts: true
  extends:
    - .gcp_test_env # sets before_script and variables
    - .docker_builder_image
  cache: []
  services:
    - docker:26-dind
  script:
    - !reference [.setup_docker_gcp_auth, script]
    - docker load -i scratch-git/image.tar
    # Push twice, tagged as both 'latest' and '$CI_COMMIT_SHORT_SHA'
    - docker tag spinner/spinner-scratch-git:latest ${GCP_REGISTRY_URL}/spinner-scratch-git:$CI_COMMIT_SHORT_SHA
    - docker push ${GCP_REGISTRY_URL}/spinner-scratch-git:$CI_COMMIT_SHORT_SHA
    - docker tag spinner/spinner-scratch-git:latest ${GCP_REGISTRY_URL}/spinner-scratch-git:latest
    - docker push ${GCP_REGISTRY_URL}/spinner-scratch-git:latest
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - gitlab-ci/stages/03-push-images.yml
      when: manual
      allow_failure: true
    - !reference [.rules, on_merge_to_master]

push scratch-git image to production artifact registry:
  stage: push images
  needs:
    - job: build scratch-git docker image
      artifacts: true
  extends:
    - .gcp_production_env # sets before_script and variables
    - .docker_builder_image
  cache: []
  services:
    - docker:26-dind
  script:
    - !reference [.setup_docker_gcp_auth, script]
    - docker load -i scratch-git/image.tar
    # Push twice, tagged as both 'latest' and '$CI_COMMIT_SHORT_SHA'
    - docker tag spinner/spinner-scratch-git:latest ${GCP_REGISTRY_URL}/spinner-scratch-git:$CI_COMMIT_SHORT_SHA
    - docker push ${GCP_REGISTRY_URL}/spinner-scratch-git:$CI_COMMIT_SHORT_SHA
    - docker tag spinner/spinner-scratch-git:latest ${GCP_REGISTRY_URL}/spinner-scratch-git:latest
    - docker push ${GCP_REGISTRY_URL}/spinner-scratch-git:latest
  rules:
    - !reference [.rules, on_merge_to_prod]
#endregion
