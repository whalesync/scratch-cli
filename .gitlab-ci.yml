# GitLab CI/CD Pipeline for Spinner Project
# Treats client, server, pydantic-ai-agent, and mcp as separate subprojects

stages:
  - setup
  - test
  - build

variables:
  # Node.js version for client and server
  NODE_VERSION: "20"
  # Python version for pydantic-ai-agent
  PYTHON_VERSION: "3.11"
  # Cache paths
  YARN_CACHE_DIR: "$CI_PROJECT_DIR/.yarn-cache"
  NPM_CACHE_DIR: "$CI_PROJECT_DIR/.npm-cache"
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.pip-cache"

# Global before_script for Node.js projects
.node_before_script: &node_before_script
  image: node:$NODE_VERSION
  before_script:
    - yarn config set cache-folder $YARN_CACHE_DIR

# Global before_script for Python projects
.python_before_script: &python_before_script
  image: python:python:3.12-alpine
  before_script:
    - python -V
    - pip install --upgrade pip
    - pip install -r requirements.txt

# Cache configuration
cache:
  paths:
    - .yarn-cache/
    - .npm-cache/
    - .pip-cache/
    - client/node_modules/
    - server/node_modules/

# =============================================================================
# CLIENT SUBPROJECT
# =============================================================================

# client:install:
#   stage: setup
#   <<: *node_before_script
#   script:
#     - cd client
#     - yarn install --frozen-lockfile
#   artifacts:
#     paths:
#       - client/node_modules/
#     expire_in: 1 hour
#   only:
#     changes:
#       - client/package.json
#       - client/yarn.lock
#     refs:
#       - merge_requests
#       - master

# client:build:
#   stage: build
#   <<: *node_before_script
#   script:
#     - cd client
#     - yarn lint
#     - yarn build
#   artifacts:
#     paths:
#       - client/.next/
#     expire_in: 1 week
#   dependencies:
#     - client:install
#   only:
#     changes:
#       - client/**/*
#     refs:
#       - merge_requests
#       - master

# =============================================================================
# SERVER SUBPROJECT
# =============================================================================

server:install:
  stage: setup
  <<: *node_before_script
  script:
    - cd server
    - yarn install --frozen-lockfile
    - yarn prisma generate
  artifacts:
    paths:
      - server/node_modules/
      - server/prisma/
    expire_in: 1 hour
  only:
    changes:
      - server/package.json
      - server/yarn.lock
      - server/prisma/schema.prisma
    refs:
      - merge_requests
      - master

server:test:
  stage: test
  <<: *node_before_script
  script:
    - cd server
    - yarn test
  dependencies:
    - server:install
  only:
    changes:
      - server/**/*
    refs:
      - merge_requests
      - master

server:build:
  stage: build
  <<: *node_before_script
  script:
    - cd server
    - yarn lint
    - yarn build
  artifacts:
    paths:
      - server/dist/
    expire_in: 1 week
  dependencies:
    - server:install
  only:
    changes:
      - server/**/*
    refs:
      - merge_requests
      - master
# # =============================================================================
# # MCP SUBPROJECT
# # =============================================================================

# mcp:install:
#   stage: setup
#   <<: *node_before_script
#   script:
#     - cd mcp
#     - yarn install --frozen-lockfile
#   artifacts:
#     paths:
#       - mcp/node_modules/
#     expire_in: 1 hour
#   only:
#     changes:
#       - mcp/package.json
#       - mcp/yarn.lock
#     refs:
#       - merge_requests
#       - master

# mcp:build:
#   stage: build
#   <<: *node_before_script
#   script:
#     - cd mcp
#     - yarn build
#   artifacts:
#     paths:
#       - mcp/dist/
#     expire_in: 1 week
#   dependencies:
#     - mcp:install
#   only:
#     changes:
#       - mcp/**/*
#     refs:
#       - merge_requests
#       - master
# =============================================================================
# PYDANTIC-AI-AGENT SUBPROJECT
# =============================================================================

# pydantic-ai-agent:install:
#   stage: setup
#   image: python:$PYTHON_VERSION
#   <<: *python_before_script
#   script:
#     - cd pydantic-ai-agent
#     - python -m venv venv
#     - source venv/bin/activate
#     - pip install -r requirements.txt
#   artifacts:
#     paths:
#       - pydantic-ai-agent/venv/
#     expire_in: 1 hour
#   only:
#     changes:
#       - pydantic-ai-agent/requirements.txt
#     refs:
#       - merge_requests
#       - master

# pydantic-ai-agent:test:
#   stage: test
#   image: python:$PYTHON_VERSION
#   <<: *python_before_script
#   script:
#     - cd pydantic-ai-agent
#     - source venv/bin/activate
#     - python -m pytest tests/ -v
#   dependencies:
#     - pydantic-ai-agent:install
#   only:
#     changes:
#       - pydantic-ai-agent/**/*
#     refs:
#       - merge_requests
#       - master

# pydantic-ai-agent:lint:
#   stage: test
#   image: python:$PYTHON_VERSION
#   <<: *python_before_script
#   script:
#     - cd pydantic-ai-agent
#     - source venv/bin/activate
#     - black --check .
#     - flake8 .
#   dependencies:
#     - pydantic-ai-agent:install
#   only:
#     changes:
#       - pydantic-ai-agent/**/*
#     refs:
#       - merge_requests
#       - master
