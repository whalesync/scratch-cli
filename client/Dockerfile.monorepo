# Multi-stage Dockerfile for Next.js client in monorepo
# Build from root directory: docker build -f client/Dockerfile.monorepo -t client .
# Taken from https://nextjs.org/docs/deployment

# Stage 1: Install dependencies
FROM node:22.20.0-alpine AS deps

# Check https://github.com/nodejs/docker-node/tree/b4117f9333da4138b03a546ec926ef50a31506c3#nodealpine to understand why libc6-compat might be needed.
RUN apk add --no-cache libc6-compat

# NOTE(ryder): Added this as different from the sample. I think its needed because i'm on an M1?
RUN apk add --no-cache g++ make py3-pip git

WORKDIR /app

# Copy root package files
COPY ./yarn.lock /app/yarn.lock
COPY ./package.json /app/package.json

# Copy and build shared-types package
COPY ./packages/shared-types/package.json /app/packages/shared-types/package.json
COPY ./packages/shared-types/tsconfig.json /app/packages/shared-types/tsconfig.json
COPY ./packages/shared-types/src/ /app/packages/shared-types/src/

WORKDIR /app/packages/shared-types/
RUN yarn install --immutable
RUN yarn build

# Copy and install client dependencies
WORKDIR /app
COPY ./client/package.json /app/client/package.json
COPY ./client/yarn.lock /app/client/yarn.lock

WORKDIR /app/client
RUN yarn install --immutable

# Stage 2: Build the application
FROM node:22.20.0-alpine AS builder

WORKDIR /app

# Copy shared-types from deps stage
COPY --from=deps /app/packages/shared-types/node_modules /app/packages/shared-types/node_modules
COPY --from=deps /app/packages/shared-types/dist /app/packages/shared-types/dist
COPY --from=deps /app/packages/shared-types/package.json /app/packages/shared-types/package.json

# Copy client dependencies and source (including root node_modules for workspace resolution)
COPY --from=deps /app/node_modules /app/node_modules
COPY --from=deps /app/client/node_modules /app/client/node_modules
COPY ./client/ /app/client/

# Next.js automatically assigns this in next build, but set it just to be safe
ENV NODE_ENV=production

# Define a flavor we can set at docker build time.
# Valid values: 'production', 'staging', 'test', 'development'
# A couple weird things here:
# 1. Prefixing it with "NEXT_PUBLIC_" means it will be available in client AND server code (so no secrets).
# 2. NODE_ENV has special meaning in nextjs and can't be overridden to staging.
# 3. Declaring it as an arg lets us provide it with `docker build --build-arg ...`
ARG APP_ENV
ENV NEXT_PUBLIC_APP_ENV ${APP_ENV}

ARG BUILD_VERSION
ENV NEXT_PUBLIC_BUILD_VERSION ${BUILD_VERSION}

ARG CLERK_PUBLISHABLE_KEY
ENV NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY ${CLERK_PUBLISHABLE_KEY}

ARG NEXT_PUBLIC_POSTHOG_KEY
ENV NEXT_PUBLIC_POSTHOG_KEY ${NEXT_PUBLIC_POSTHOG_KEY}

ARG NEXT_PUBLIC_POSTHOG_HOST=https://us.i.posthog.com
ENV NEXT_PUBLIC_POSTHOG_HOST ${NEXT_PUBLIC_POSTHOG_HOST}

ARG NEXT_PUBLIC_API_URL=http://localhost:3010
ENV NEXT_PUBLIC_API_URL ${NEXT_PUBLIC_API_URL}

ARG NEXT_PUBLIC_AI_AGENT_WEBSOCKET_URL=ws://localhost:8000
ENV NEXT_PUBLIC_AI_AGENT_WEBSOCKET_URL ${NEXT_PUBLIC_AI_AGENT_WEBSOCKET_URL}

ARG NEXT_PUBLIC_AI_AGENT_API_URL=http://localhost:8000
ENV NEXT_PUBLIC_AI_AGENT_API_URL ${NEXT_PUBLIC_AI_AGENT_API_URL}

ARG NEXT_PUBLIC_GA_ID
ENV NEXT_PUBLIC_GA_ID ${NEXT_PUBLIC_GA_ID}

WORKDIR /app/client
RUN yarn build

# Stage 3: Production runtime
FROM node:22.20.0-alpine AS runner

WORKDIR /app

ENV NODE_ENV=production

RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nextjs

# Copy shared-types from builder stage
COPY --from=builder /app/packages/shared-types/dist /app/packages/shared-types/dist
COPY --from=builder /app/packages/shared-types/package.json /app/packages/shared-types/package.json

# You only need to copy next.config.js if you are NOT using the default configuration
COPY --from=builder /app/client/next.config.ts ./client/
COPY --from=builder /app/client/public /app/client/public
COPY --from=builder /app/client/package.json /app/client/package.json

# Automatically leverage output traces to reduce image size
# https://nextjs.org/docs/advanced-features/output-file-tracing
# Note: standalone output includes full monorepo structure, so copying to /app/ places files correctly
COPY --from=builder --chown=nextjs:nodejs /app/client/.next/standalone /app/
COPY --from=builder --chown=nextjs:nodejs /app/client/.next/static /app/client/.next/static
# Copy node_modules - in monorepo, deps are hoisted to root /app/node_modules
COPY --from=deps --chown=nextjs:nodejs /app/node_modules /app/node_modules

USER nextjs

EXPOSE 3000

ENV PORT=3000
ENV RUNNING_IN_CLOUD=false
ENV APP_ENV=test

# server.js is at /app/server.js (standalone output places it at root)
WORKDIR /app
CMD ["node", "server.js"]
