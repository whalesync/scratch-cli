import { SUPABASE_SYSTEM_SCHEMAS } from '../pg-common';

/**
 * Build the PL/pgSQL to create a service account role with permissions on all user schemas.
 */
export function buildCreateUserSQL(username: string, password: string): string {
  const excludedSchemas = [...SUPABASE_SYSTEM_SCHEMAS].map((s) => `'${s}'`).join(', ');
  // Note: username and password are generated by us (UUID-based), not user input
  return `
DO $$
DECLARE
  schema_record RECORD;
BEGIN
  IF NOT EXISTS (SELECT FROM pg_catalog.pg_roles WHERE rolname = '${username}') THEN
    CREATE ROLE "${username}" LOGIN PASSWORD '${password}' BYPASSRLS;
  END IF;

  FOR schema_record IN
    SELECT schema_name FROM information_schema.schemata
    WHERE schema_name NOT IN (${excludedSchemas})
    AND schema_name NOT LIKE 'pg\\_%'
    AND schema_name NOT LIKE 'supabase\\_%'
  LOOP
    EXECUTE format('GRANT ALL ON SCHEMA %I TO "${username}"', schema_record.schema_name);
    EXECUTE format('GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA %I TO "${username}"', schema_record.schema_name);
    EXECUTE format('GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA %I TO "${username}"', schema_record.schema_name);
    EXECUTE format('GRANT ALL PRIVILEGES ON ALL FUNCTIONS IN SCHEMA %I TO "${username}"', schema_record.schema_name);
    EXECUTE format('ALTER DEFAULT PRIVILEGES IN SCHEMA %I GRANT ALL ON TABLES TO "${username}"', schema_record.schema_name);
    EXECUTE format('ALTER DEFAULT PRIVILEGES IN SCHEMA %I GRANT ALL ON SEQUENCES TO "${username}"', schema_record.schema_name);
    EXECUTE format('ALTER DEFAULT PRIVILEGES IN SCHEMA %I GRANT ALL ON FUNCTIONS TO "${username}"', schema_record.schema_name);
  END LOOP;
END
$$;`;
}

/**
 * Build a connection string by replacing the username and password in the pooler URL.
 * Handles Supavisor shared-endpoint format where username includes project ref.
 */
export function buildConnectionString(
  poolerConnectionString: string,
  username: string,
  password: string,
  projectRef: string,
): string {
  try {
    const url = new URL(poolerConnectionString);
    // Supavisor shared endpoints use username format: user.projectRef
    if (url.username.includes('.')) {
      url.username = `${username}.${projectRef}`;
    } else {
      url.username = username;
    }
    url.password = encodeURIComponent(password);
    return url.toString();
  } catch {
    // Fallback: simple string replacement
    return poolerConnectionString
      .replace(/\/\/[^:]+:/, `//${username}:`)
      .replace(/:([^@]+)@/, `:${encodeURIComponent(password)}@`);
  }
}
