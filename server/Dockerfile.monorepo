# Multi-stage Dockerfile for NestJS server in monorepo
# Build from root directory: docker build -f server/Dockerfile.monorepo -t server .

# Stage 1: Install dependencies
FROM node:22.20.0-alpine AS deps

# Install build dependencies (including git for some npm packages)
RUN apk add --no-cache libc6-compat g++ make py3-pip git

WORKDIR /app

# Copy root package files
COPY ./yarn.lock /app/yarn.lock
COPY ./package.json /app/package.json

# Copy and build shared-types package
COPY ./packages/shared-types/package.json /app/packages/shared-types/package.json
COPY ./packages/shared-types/tsconfig.json /app/packages/shared-types/tsconfig.json
COPY ./packages/shared-types/src/ /app/packages/shared-types/src/

WORKDIR /app/packages/shared-types/
RUN yarn install --immutable
RUN yarn build

# Copy and install server dependencies
WORKDIR /app
COPY ./server/package.json /app/server/package.json
COPY ./server/yarn.lock /app/server/yarn.lock
COPY ./server/prisma/ /app/server/prisma/

WORKDIR /app/server
RUN yarn install --frozen-lockfile

# Stage 2: Build the application
FROM node:22.20.0-alpine AS builder

ARG BUILD_VERSION=0.0.0-local

WORKDIR /app

# Copy shared-types from deps stage
COPY --from=deps /app/packages/shared-types/node_modules /app/packages/shared-types/node_modules
COPY --from=deps /app/packages/shared-types/dist /app/packages/shared-types/dist
COPY --from=deps /app/packages/shared-types/package.json /app/packages/shared-types/package.json

# Copy server dependencies and source (including root node_modules for Prisma client)
COPY --from=deps /app/node_modules /app/node_modules
COPY --from=deps /app/server/node_modules /app/server/node_modules
COPY ./server/src/ /app/server/src
COPY ./server/prisma/ /app/server/prisma
COPY ./server/nest-cli.json ./server/package.json ./server/tsconfig.build.json ./server/tsconfig.json /app/server/

WORKDIR /app/server

# Update version and build
RUN sed -i "s/0.0.0-local/${BUILD_VERSION}/g" /app/server/src/version.ts && \
    yarn run prisma generate && yarn run build

# Stage 3: Production runtime
FROM node:22.20.0-alpine AS runner

# Install dumb-init for proper signal handling
# https://engineeringblog.yelp.com/2016/01/dumb-init-an-init-for-docker.html
RUN apk add --no-cache dumb-init curl

WORKDIR /app

# Copy built application and dependencies (need both root and server node_modules)
COPY --from=builder /app/node_modules /app/node_modules
COPY --from=builder /app/server/node_modules /app/server/node_modules
COPY --from=builder /app/packages/shared-types/dist /app/packages/shared-types/dist
COPY --from=builder /app/packages/shared-types/package.json /app/packages/shared-types/package.json
COPY --from=builder /app/server/dist /app/server/dist

# Set up environment variables
# These platform-specific vars are passed in from the CI/CD builder
# Service and env-specific type vars (production/staging/test, frontend/data/jobqueue) are supplied at runtime
ENV RUNNING_IN_CLOUD=false
ENV PORT=8080

# These should be passed in as env vars, not built into the image
ENV NODE_ENV=test
ENV APP_ENV=test

EXPOSE 8080

# Run from server directory so node module resolution works correctly
WORKDIR /app/server
CMD [ "dumb-init", "node", "dist/main" ]
