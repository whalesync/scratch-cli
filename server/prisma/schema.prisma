// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["relationJoins", "nativeDistinct"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  USER
  ADMIN
}

model User {
  id                      String                   @id // type: UserId
  createdAt               DateTime                 @default(now())
  updatedAt               DateTime                 @updatedAt
  clerkId                 String?                  @unique
  name                    String?
  email                   String?
  role                    UserRole                 @default(USER)
  stripeCustomerId        String?                  @unique
  organizationId          String?
  organization            Organization?            @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  settings                Json?                    @default("{}") // UserSettings object 
  apiTokens               APIToken[]
  connectorAccounts       ConnectorAccount[]
  styleGuides             StyleGuide[]
  aiAgentCredentials      AiAgentCredential[]
  aiAgentTokenUsageEvents AiAgentTokenUsageEvent[]
  subscriptions           Subscription[]
  invoiceResults          InvoiceResult[]
  jobs                    DbJob[]
  workbooks               Workbook[]
  uploads                 Upload[]
}

enum TokenType {
  AGENT // For AI agents
  WEBSOCKET // For client web socket connections
  USER // For user API tokens
}

model APIToken {
  id        String    @id // type: APITokenId
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  token     String
  createdAt DateTime  @default(now())
  expiresAt DateTime  @updatedAt
  type      TokenType @default(AGENT)
  scopes    String[] // Optional list of scopes for the token like 'read:snapshots', 'write:snapshots', ...

  @@unique([token])
  @@index([userId])
}

enum AiAgentCredentialSource {
  USER
  SYSTEM
}

// Defines a set of credentials for the AI agent to use instead of the default ones, such as an OpenRouter API key
model AiAgentCredential {
  id               String                  @id // type: AiAgentCredentialId
  createdAt        DateTime                @default(now())
  updatedAt        DateTime                @updatedAt
  user             User                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId           String
  service          String
  apiKey           String
  description      String?
  externalApiKeyId String? // used to store the external ID or hash for an api key when generated via an SDK
  source           AiAgentCredentialSource @default(USER) // where the api key came from user or system generated 
  enabled          Boolean                 @default(true)
  default          Boolean                 @default(false)

  @@index([userId])
}

model ConnectorAccount {
  id                        String                 @id // type: ConnectorAccountId
  createdAt                 DateTime               @default(now())
  updatedAt                 DateTime               @updatedAt
  user                      User?                  @relation(fields: [userId], references: [id], onDelete: SetNull)
  userId                    String?
  organizationId            String
  organization              Organization           @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  service                   Service
  displayName               String
  authType                  AuthType               @default(USER_PROVIDED_PARAMS)
  encryptedCredentials      Json                   @default("{}") // Encrypted JSON containing apiKey, oauth tokens, etc.
  healthStatus              ConnectorHealthStatus?
  healthStatusLastCheckedAt DateTime?
  healthStatusMessage       String? // Message if health status is not OK
  modifier                  String? // ID of the custom connector or other modifier entity
  extras                    Json? // Additional service-specific configuration
  snapshotTables            SnapshotTable[]

  @@index([userId])
  @@index([organizationId])
}

enum Service {
  NOTION
  AIRTABLE
  CSV
  POSTGRES
  YOUTUBE
  WORDPRESS
  WEBFLOW
  WIX_BLOG
}

enum AuthType {
  API_KEY // Deprecated
  OAUTH
  USER_PROVIDED_PARAMS
}

enum ConnectorHealthStatus {
  OK
  FAILED
}

model Workbook {
  id        String   @id // type: WorkbookId
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user           User?        @relation(fields: [userId], references: [id], onDelete: SetNull)
  userId         String?
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  snapshotTables SnapshotTable[]

  @@index([userId])
  @@index([organizationId])
}

model SnapshotTable {
  id        String   @id // type: SnapshotTableId
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  workbook   Workbook @relation(fields: [workbookId], references: [id], onDelete: Cascade)
  workbookId String

  connectorAccount   ConnectorAccount? @relation(fields: [connectorAccountId], references: [id], onDelete: SetNull)
  connectorAccountId String?

  // Service type for this table (e.g., CSV, AIRTABLE, NOTION)
  // Required field - stored denormalized for performance and to support CSV (which has no connector account)
  connectorService Service

  // Single TableSpec object (not array)
  tableSpec Json // TableSpec 

  /// Map of user settings for the columns in this table
  /// type: SnapshotColumnSettingsMap.
  columnSettings Json @default("{}")

  // SQL WHERE clause filter for this table
  activeRecordSqlFilter String?

  // Page size limit for records (null means unlimited)
  pageSize Int? @default(1000)

  // Whether this table is hidden from the UI
  hidden Boolean @default(false)

  // Whether records are currently being synced/downloaded for this table
  syncInProgress Boolean @default(false)

  // Timestamp of the last successful sync (download or publish)
  lastSyncTime DateTime?

  // Columns that are hidden from the UI and agent, list of column wsIds
  hiddenColumns String[] @default([])

  // Dynamic table name in the snapshot schema (e.g., "snt_abc123_my_table")
  // v0: tableName = wsId from tableSpec.id.wsId
  // v1: tableName = {id}_{sanitized_name}
  tableName String @default("")

  // Version of the table naming scheme
  // v0: uses wsId from connector as table name
  // v1: uses {id}_{wsId} format
  version String @default("v0")

  @@index([workbookId])
  @@index([connectorAccountId])
  @@index([version])
}

model StyleGuide {
  id               String       @id // type: StyleGuideId
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  name             String
  body             String // Markdown content
  user             User?        @relation(fields: [userId], references: [id], onDelete: SetNull)
  userId           String?
  organizationId   String
  organization     Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  autoInclude      Boolean      @default(false) // Whether to automatically include this style guide in conversations
  sourceUrl        String? // URL of where this resource an be download from
  contentType      String       @default("markdown") // "markdown" | "json" | "text"
  lastDownloadedAt DateTime? // When the resource was last downloaded
  tags             String[] // User defined tags for the resource

  @@index([userId])
  @@index([organizationId])
}

model AiAgentTokenUsageEvent {
  id             String   @id // type: AiAgentTokenUsageEventId
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId         String
  model          String
  requests       Int
  requestTokens  Int
  responseTokens Int
  totalTokens    Int
  context        Json? // additional context for the event

  @@index([userId])
}

/// A user's subscription with stripe.
/// There *should* only ever be one of these for a user, but we track any subscriptions stripe sends our way.
model Subscription {
  id                   String       @id // type: SubscriptionId
  createdAt            DateTime     @default(now())
  updatedAt            DateTime     @updatedAt
  version              Int          @default(1)
  user                 User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId               String // the subscription must be assocated with a user that has the customer ID in Stripe
  organizationId       String
  organization         Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  productType          String
  stripeSubscriptionId String       @unique
  expiration           DateTime
  priceInDollars       Int          @default(0)
  stripeStatus         String?
  /// Set when we receive invoice.paid or invoice.payment_failed webhooks.
  lastInvoicePaid      Boolean?

  @@index([userId])
  @@index([organizationId])
}

/// Simple log to cache whether a user's subscription is getting paid.
/// Stripe is the authoritative source for this.
model InvoiceResult {
  id        String   @id // type: InvoiceResultId
  createdAt DateTime @default(now())

  /// Stripe invoice ID
  invoiceId String

  /// The user that the invoice is for.
  userId         String?
  user           User?        @relation(fields: [userId], references: [id], onDelete: SetNull)
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // True if the invoice was paid.
  succeeded Boolean

  @@index([userId])
  @@index([organizationId])
  @@index([invoiceId])
}

model AgentSession {
  id         String   @id // The session ID used by the pydantic agent
  userId     String // User ID for the session
  workbookId String // Workbook ID for the session
  data       Json // JSON data containing the session state
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([userId])
  @@index([workbookId])
  @@index([userId, workbookId])
}

model DbJob {
  id        String  @id // type: JobId
  bullJobId String? // BullMQ job ID for tracking

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  progress    Json? // Job progress data
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId      String
  status      String
  type        String
  data        Json // Job-specific data
  result      Json? // Job result data
  error       String? // Error message if failed
  processedOn DateTime? // When job actually started processing
  finishedOn  DateTime? // When job completed (success or failure)

  @@index([userId])
  @@index([status])
  @@index([type])
  @@map("Job")
}

model Upload {
  id             String       @id // type: UploadId
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  user           User?        @relation(fields: [userId], references: [id], onDelete: SetNull)
  userId         String?
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  name           String // Upload name/filename
  type           String // "CSV" | "MD" - stored as string for flexibility
  typeId         String // Reference to csv table name or MdUpload record id

  @@index([userId])
  @@index([type])
  @@index([organizationId])
}

model AuditLogEvent {
  id             String   @id // type: AuditLogEventId
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  userId         String? // user who triggered the event, don't use FK for this field
  organizationId String? // organization that owns the entity that was affected by this event, don't use FK for this field
  message        String // message describing the event
  eventType      String // create, update, delete, publish, etc.
  entityId       String // ID of the entity that was affected by this event like a workbook or connection
  context        Json? // Additional details about the event that can be used to to show what changed or store additional context

  @@index([userId])
  @@index([organizationId])
  @@index([entityId])
}

model Organization {
  id        String   @id // type: OrganizationId
  clerkId   String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  name      String

  users             User[]
  styleGuides       StyleGuide[]
  connectorAccounts ConnectorAccount[]
  workbooks         Workbook[]
  uploads           Upload[]
  subscriptions     Subscription[]
  invoiceResults    InvoiceResult[]
}
