sequenceDiagram
    participant Client as Client (Browser)
    participant Server as Agent Server
    participant Agent as AI Agent

    Note over Client,Agent: 1. Create Session (HTTP)
    Client->>Server: POST /sessions<br/>{name, workbook_id}
    Server-->>Client: {session_id, capabilities}

    Note over Client,Agent: 2. Open WebSocket Connection
    Client->>Server: WebSocket Connect<br/>ws://{host}/ws/{session_id}?auth={jwt}
    Server->>Server: Validate JWT & session
    Server-->>Client: connection_confirmed

    Note over Client,Agent: 3. Send User Message
    Client->>Server: message<br/>{message, model, capabilities, ...}
    Server-->>Client: message_progress (task_started)

    Note over Client,Agent: 4. Agent Processing
    Server->>Agent: Process message
    Server-->>Client: message_progress (run_started)
    Server-->>Client: message_progress (create_agent)

    loop Agent Execution
        Agent->>Agent: Use tools & reason
        Server-->>Client: message_progress (tool_call)
        Server-->>Client: message_progress (tool_result)
    end

    Note over Client,Agent: 5. Return Final Result
    Agent-->>Server: Final response
    Server-->>Client: message_response<br/>{response_message, usage_stats}

    Note over Client,Agent: 6. Optional: Stop Agent
    Client->>Server: stop<br/>{task_id, hard_kill}
    Server->>Agent: Cancel execution
    Agent-->>Server: Stopped
    Server-->>Client: message_response<br/>"Request stopped by user"

    Note over Client,Agent: 7. Error Handling
    alt Error Occurs
        Agent-->>Server: Error
        Server-->>Client: agent_error<br/>{detail: error_message}
    end

    Note over Client,Agent: 8. Disconnect
    Client->>Server: WebSocket Close
    Server-->>Client: Connection closed

    Note over Client,Agent: Message Types
    Note right of Server: Client → Server:<br/>• message<br/>• ping<br/>• stop
    Note left of Client: Server → Client:<br/>• connection_confirmed<br/>• message_progress<br/>• message_response<br/>• agent_error
